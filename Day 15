Day 15 – Multiple Joins

Focus: Combining three or more tables in a single query.

✅ Learnings:

- LEFT JOIN → keep all rows from the main table; INNER JOIN → only matching rows.
- Join order matters; results are cumulative.
- Use table aliases and fully qualify columns.
- Chain multiple joins to connect more tables.
- Use DISTINCT or GROUP BY to avoid duplicates.
- Test joins incrementally – add one join at a time to verify results.

✅ Practice Questions:

-- 1. Join patients, staff, and staff_schedule to show patient service and staff availability.
select
p.patient_id,
p.name,
p.service,
s.staff_id,
s.role,
st.week,
st.present
from patients as p
join staff as s
on p.service = s.service
Left Join staff_schedule  as st
on s.staff_id = st.staff_id;

-- 2.Combine services_weekly with staff and staff_schedule for comprehensive service analysis.
select
	sw.week,
	sw.service,
	sw.patients_admitted,
	sw.patients_refused,
	sw.patient_satisfaction,
	s.staff_id,
	s.role,
	st.present
from services_weekly as sw
left join staff as s
on sw.service = s.service
left join staff_schedule as st
on s.staff_id = st.staff_id
and sw.week = st.week;

-- 3.Create a multi-table report showing patient admissions with staff information.
select
p.patient_id,
p.service,
p.arrival_date as admission_date,
sw.week,
sw.patients_admitted,
s.staff_id,
s.staff_name,
s.role
from patients as p
left join services_weekly as sw
on p.service =  sw.service
left join staff as s
on sw.service = s.service;


/* Day 15 Question: Create a comprehensive service analysis report for week 20 showing: service name, total patients admitted that week, total patients refused, 
average patient satisfaction, count of staff assigned to service, and count of staff present that week.
 Order by patients admitted descending.*/
 
 SELECT
    sw.service,
    SUM(sw.patients_admitted) AS total_patients_admitted,
    SUM(sw.patients_refused) AS total_patients_refused,
    AVG(sw.patient_satisfaction) AS avg_patient_satisfaction,
    COUNT(DISTINCT s.staff_id) AS total_staff,
    COUNT(CASE WHEN st.present = 1 THEN 1  END) AS total_staff_present
FROM services_weekly AS sw
LEFT JOIN staff AS s
    ON sw.service = s.service
LEFT JOIN staff_schedule AS st
    ON s.staff_id = st.staff_id
    AND sw.week = st.week
WHERE sw.week = 20
GROUP BY sw.week, sw.service
ORDER BY total_patients_admitted DESC;


